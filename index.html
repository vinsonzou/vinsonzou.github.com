<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.83.1" />

  <title>ops</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://ops.m114.org/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://ops.m114.org/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://ops.m114.org/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  
  <link rel="alternate" type="application/rss+xml" title="ops"
    href='https://ops.m114.org/index.xml' />
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://ops.m114.org/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://ops.m114.org/">Ops</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://ops.m114.org/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://ops.m114.org/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://ops.m114.org/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://ops.m114.org/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://ops.m114.org/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href='https://ops.m114.org/index.xml'><i
          class="fas fa-rss fa-fw"></i>RSS</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/vinsonzou" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2014-2021. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>ops</h1>
  <h2>records of learning.</h2>
</div>

<div class="content">
  
    <article>
  <header>
    <h2><a href="https://ops.m114.org/post/nginx-wechat-ops/">lua实现微信机器人</a></h2>

    <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2021/06/11, 10:08</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://ops.m114.org/topics/OpenResty">OpenResty</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/OpenResty">OpenResty</a>
    
  </div>
  
  

</div>

  </header>

  <p>
  使用企业微信调整值班人员信息，示例为联系人tag调整，可以自定义任何想实现功能。
环境  CentOS 7 Nginx  lua-nginx-module lua-resty-http lua实现微信加密库 xml2lua   依赖服务  企业微信    配置 对应nginx配置
server { listen 443 ssl http2; ssl_certificate test.crt; ssl_certificate_key test.key; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_prefer_server_ciphers on; ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5; ssl_session_timeout 1d; ssl_session_cache shared:SSL:20m; add_header Strict-Transport-Security max-age=31536000; server_name wx-ops.test.com; access_log logs/wechat-ops.access.log main; error_log logs/wechat-ops.info; location /api/ { resolver local=on ipv6=off; resolver_timeout 2s; lua_ssl_verify_depth 1; lua_ssl_trusted_certificate /etc/pki/tls/certs/ca-bundle.crt; content_by_lua_file lua/wechat-ops.lua; } } wechat_ops.lua
  </p>

  
  <footer>
    <a href="https://ops.m114.org/post/nginx-wechat-ops/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="https://ops.m114.org/post/MySQL-plugin-Audit/">MySQL插件之审计</a></h2>

    <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2021/06/08, 14:10</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://ops.m114.org/topics/MySQL">MySQL</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/MySQL">MySQL</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/%E7%AD%89%E4%BF%9D">等保</a>
    
  </div>
  
  

</div>

  </header>

  <p>
  目录  等保需求 背景 插件安装 插件配置  等保需求  审计功能：记录时间、来源IP、用户、行为、数据库、SQL。  背景 Oracle 的 MySQL 社区版不带审计插件（Audit Plugin），要想使用审计功能，你可以用企业版，不过这需要银子。业界还有一些 GPL 协议的审计插件，这里我们选择 MariaDB 的审计插件。
 系统版本: CentOS 7.4 MySQL版本: 5.7.23 社区版 MariaDB审计插件版本: 1.4.7  备注:
 MariaDB审计插件一直在更新，不同版本的审计插件功能也不同，每个版本的功能见：https://mariadb.com/kb/en/mariadb-audit-plugin-options-and-system-variables/#server_audit_events 我们在给MySQL数据库安装审计插件时，需要从MariaDB里面拷贝审计插件。MariaDB版本与审计插件版本关系如下：https://mariadb.com/kb/en/mariadb-audit-plugin-versions/  插件安装 MariaDB 的 10.1 版本对应与 Oracle 的 MySQL 5.7，我们到它的官网上下载 Linux 的通用版本。
找到我们需要的审计插件：
./mariadb-10.1.48-linux-x86_64/lib/plugin/server_audit.so 把这个 so 结尾的文件拷贝到 MySQL 的插件目录，例如：/usr/local/mysql/lib/plugin/
-- 配置文件增加以下配置 [mysqld] plugin_load_add = server_audit server_audit = FORCE_PLUS_PERMANENT # 防止审计插件被卸载 server_audit_logging = on server_audit_events = CONNECT,TABLE,QUERY_DDL,QUERY_DCL,QUERY_DML_NO_SELECT server_audit_file_rotate_size = 268435456 server_audit_file_rotations = 64 -- 插件动态安装启用 mysql&gt; install plugin server_audit SONAME &#39;server_audit.
  </p>

  
  <footer>
    <a href="https://ops.m114.org/post/MySQL-plugin-Audit/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="https://ops.m114.org/post/MySQL-plugin-validate-password/">MySQL插件之密码复杂性</a></h2>

    <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2021/06/08, 13:30</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://ops.m114.org/topics/MySQL">MySQL</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/MySQL">MySQL</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/%E7%AD%89%E4%BF%9D">等保</a>
    
  </div>
  
  

</div>

  </header>

  <p>
  目录  等保需求 插件介绍 插件安装 插件配置  等保需求  用户密码复杂度：3种字符以上，至少8位长度。使用 validate_password 插件实现。  插件介绍 MySQL 5.6/5.7 上密码复杂度策略实现, MySQL 8.0有组件实现方式，同时也支持插件方式。
插件安装 -- 配置文件增加以下配置 [mysqld] plugin-load-add = validate_password.so validate-password = FORCE_PLUS_PERMANENT -- 插件动态安装启用 mysql&gt; INSTALL PLUGIN validate_password soname &#39;validate_password.so&#39;; -- 验证是否正常安装 mysql&gt; SELECT PLUGIN_NAME, PLUGIN_LIBRARY, PLUGIN_STATUS, LOAD_OPTION FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = &#39;validate_password&#39;; mysql&gt; SHOW PLUGINS; 注意：参数FORCE_PLUS_PERMANENT是为了防止插件在MySQL运行的时候被卸载，如下所示，当你卸载插件时就会报错： mysql&gt; UNINSTALL PLUGIN validate_password; ERROR 1702 (HY000): Plugin &#39;validate_password&#39; is force_plus_permanent and can not be unloaded 插件配置 -- 查看默认相关变量 mysql&gt; show variables like &#39;validate_password%&#39;; +--------------------------------------+--------+ | Variable_name | Value | +--------------------------------------+--------+ | validate_password_check_user_name | OFF | | validate_password_dictionary_file | | | validate_password_length | 8 | | validate_password_mixed_case_count | 1 | | validate_password_number_count | 1 | | validate_password_policy | MEDIUM | | validate_password_special_char_count | 1 | +--------------------------------------+--------+ mysql&gt; select password(&#39;abc&#39;); ERROR 1819 (HY000): Your password does not satisfy the current policy requirements mysql&gt; select password(&#39;abc123&#39;); ERROR 1819 (HY000): Your password does not satisfy the current policy requirements mysql&gt; select password(&#39;abc123ABC&#39;); ERROR 1819 (HY000): Your password does not satisfy the current policy requirements mysql&gt; select password(&#39;abc123@A&#39;); 所以你更改密码必须满足：数字、小写字母、大写字母 、特殊字符、长度至少8位 参数说明:
  </p>

  
  <footer>
    <a href="https://ops.m114.org/post/MySQL-plugin-validate-password/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="https://ops.m114.org/post/MySQL-plugin-Connection-Control/">MySQL插件之Connection-Control</a></h2>

    <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2021/06/08, 13:10</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://ops.m114.org/topics/MySQL">MySQL</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/MySQL">MySQL</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/%E7%AD%89%E4%BF%9D">等保</a>
    
  </div>
  
  

</div>

  </header>

  <p>
  目录  等保需求 插件介绍 插件安装 插件配置  等保需求  登录失败策略：登录失败5次锁定10分钟，使用 Connection-Control 插件实现。  插件介绍 MySQL 5.7.17 以后提供了 Connection-Control 插件用来控制客户端在登录操作连续失败一定次数后的响应的延迟。该插件可有效的防止客户端暴力登录的风险(攻击)。该插件包含以下2个组件:
 CONNECTION_CONTROL：用来控制登录失败的次数及延迟响应时间 CONNECTION_CONTROL_FAILED_LOGIN_ATTEMPTS：该表将登录失败的操作记录至IS库中  插件安装 -- 配置文件增加以下配置 [mysqld] plugin-load-add	= connection_control.so connection-control = FORCE_PLUS_PERMANENT // 防止运行时卸载 connection-control-failed-login-attempts = FORCE_PLUS_PERMANENT // 防止运行时卸载 connection_control_min_connection_delay	= 600000 connection_control_max_connection_delay	= 2147483647 connection_control_failed_connections_threshold	= 5 -- 插件动态安装启用 mysql&gt; INSTALL PLUGIN CONNECTION_CONTROL SONAME &#39;connection_control.so&#39;; mysql&gt; INSTALL PLUGIN CONNECTION_CONTROL_FAILED_LOGIN_ATTEMPTS SONAME &#39;connection_control.so&#39;; -- 验证是否正常安装 mysql&gt; SELECT PLUGIN_NAME, PLUGIN_STATUS FROM INFORMATION_SCHEMA.
  </p>

  
  <footer>
    <a href="https://ops.m114.org/post/MySQL-plugin-Connection-Control/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="https://ops.m114.org/post/sysbench-trial/">sysbench试用</a></h2>

    <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2021/06/08, 10:10</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://ops.m114.org/topics/MySQL">MySQL</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/MySQL">MySQL</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/sysbench">sysbench</a>
    
  </div>
  
  

</div>

  </header>

  <p>
  目录  背景 环境 安装 测试  背景 主要测试开启审计插件OLTP性能损失多大，安装和测试方法如下
环境  CentOS 7.4 MySQL: 5.7.23  innodb_buffer_pool_size: 8G innodb_buffer_pool_instances: 8【默认】 innodb_buffer_pool_chunk_size: 134217728【即128M，默认值】    安装 yum install gcc gcc-c++ autoconf automake make libtool bzr mysql-devel mysql wget https://github.com/akopytov/sysbench/archive/refs/tags/1.0.20.tar.gz tar zxf 1.0.20.tar.gz cd sysbench-1.0.20 ./autogen.sh ./configure --prefix=/usr/local/sysbench make make install 测试  创建测试库  mysql&gt; create database sbtest;  测试只读性能，整个过程将持续10分钟  #准备数据 sysbench --db-driver=mysql --mysql-host=XXX --mysql-port=XXX --mysql-user=XXX --mysql-password=XXX --mysql-db=sbtest --table_size=25000 --tables=250 --events=0 --time=600 oltp_read_only prepare #运行workload sysbench --db-driver=mysql --mysql-host=XXX --mysql-port=XXX --mysql-user=XXX --mysql-password=XXX --mysql-db=sbtest --table_size=25000 --tables=250 --events=0 --time=600 --threads=XXX --percentile=95 --range_selects=0 --skip-trx=1 --report-interval=1 oltp_read_only run #清理 sysbench --db-driver=mysql --mysql-host=XXX --mysql-port=XXX --mysql-user=XXX --mysql-password=XXX --mysql-db=sbtest --table_size=25000 --tables=250 --events=0 --time=600 --threads=XXX --percentile=95 --range_selects=0 oltp_read_only cleanup  测试写入性能，整个过程将持续10分钟  #准备数据 sysbench --db-driver=mysql --mysql-host=XXX --mysql-port=XXX --mysql-user=XXX --mysql-password=XXX --mysql-db=sbtest --table_size=25000 --tables=250 --events=0 --time=600 oltp_write_only prepare #运行workload sysbench --db-driver=mysql --mysql-host=XXX --mysql-port=XXX --mysql-user=XXX --mysql-password=XXX --mysql-db=sbtest --mysql-ignore-errors=1062 --table_size=25000 --tables=250 --events=0 --time=600 --threads=XXX --percentile=95 --report-interval=1 oltp_write_only run #清理 sysbench --db-driver=mysql --mysql-host=XXX --mysql-port=XXX --mysql-user=XXX --mysql-password=XXX --mysql-db=sbtest --table_size=25000 --tables=250 --events=0 --time=600 --threads=XXX --percentile=95 oltp_write_only cleanup  测试混合读写性能，整个过程将持续10分钟  #准备数据 sysbench --db-driver=mysql --mysql-host=XXX --mysql-port=XXX --mysql-user=XXX --mysql-password=XXX --mysql-db=sbtest --table_size=25000 --tables=250 --events=0 --time=600 oltp_read_write prepare #运行workload sysbench --db-driver=mysql --mysql-host=XXX --mysql-port=XXX --mysql-user=XXX --mysql-password=XXX --mysql-db=sbtest --mysql-ignore-errors=1062 --table_size=25000 --tables=250 --events=0 --time=600 --threads=XXX --percentile=95 --report-interval=1 oltp_read_write run #清理 sysbench --db-driver=mysql --mysql-host=XXX --mysql-port=XXX --mysql-user=XXX --mysql-password=XXX --mysql-db=sbtest --table_size=25000 --tables=250 --events=0 --time=600 --threads=XXX --percentile=95 oltp_read_write cleanup FAQ Q: 128线程只读测试时，报错如下:
  </p>

  
  <footer>
    <a href="https://ops.m114.org/post/sysbench-trial/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="https://ops.m114.org/post/python-3.9.5-build-error/">python 3.9.5 编译报错 Could not import runpy module 问题</a></h2>

    <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2021/06/05, 13:15</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://ops.m114.org/topics/Python">Python</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/Python">Python</a>
    
  </div>
  
  

</div>

  </header>

  <p>
  环境  CentOS 7.3.1611 gcc-4.8.5-28.el7_5.1 Python 3.9.5  相关报错 ./python -E -S -m sysconfig --generate-posix-vars ;\ if test $? -ne 0 ; then \ 	echo &#34;generate-posix-vars failed&#34; ; \ 	rm -f ./pybuilddir.txt ; \ 	exit 1 ; \ fi Could not import runpy module Traceback (most recent call last): File &#34;/tmp/Python-3.9.5/Lib/runpy.py&#34;, line 15, in &lt;module&gt; import importlib.util File &#34;/tmp/Python-3.9.5/Lib/importlib/util.py&#34;, line 2, in &lt;module&gt; from . import abc File &#34;/tmp/Python-3.
  </p>

  
  <footer>
    <a href="https://ops.m114.org/post/python-3.9.5-build-error/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="https://ops.m114.org/post/nginx-use-mq/">lua发布消息至RocketMQ解耦</a></h2>

    <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2021/06/03, 15:08</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://ops.m114.org/topics/OpenResty">OpenResty</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/OpenResty">OpenResty</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/Nginx">Nginx</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/RocketMQ">RocketMQ</a>
    
  </div>
  
  

</div>

  </header>

  <p>
  广告点击回传数据入消息队列，避免后端处理不过来，先存入消息队列削峰。
环境  CentOS 7 Nginx  lua-nginx-module lua-resty-core lua-resty-http   依赖服务  阿里云RocketMQ    配置 对应nginx location配置
location / { access_by_lua_file lua/mq/mq.lua; } custom/mq.lua
return { AKId = &#34;xxx&#34;, -- RocketMQ的AccessKeyId AKSecret = &#34;xxx&#34;, -- RocketMQ的AccessKeySecret topic_name = &#34;xxx&#34;, -- RocketMQ的topic instance_id = &#34;xxx&#34; -- RocketMQ的instance_id } mq.lua
local require = require local ngx = ngx local config = require(&#34;custom.mq.config&#34;) local http = require &#34;resty.http&#34; local cjson = require &#34;cjson.
  </p>

  
  <footer>
    <a href="https://ops.m114.org/post/nginx-use-mq/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="https://ops.m114.org/post/dynamic-http-proxy/">使用动态 DNS 来完成 HTTP 请求</a></h2>

    <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2021/06/03, 14:38</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://ops.m114.org/topics/OpenResty">OpenResty</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/OpenResty">OpenResty</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/Nginx">Nginx</a>
    
  </div>
  
  

</div>

  </header>

  <p>
  内部访问外部http请求，通过拦截内部请求至此统一访问外部业务。
环境  CentOS 7 Nginx  lua-nginx-module lua-resty-dns lua-resty-lock lua-resty-http    配置 对应nginx配置
lua_shared_dict dns_cache 5m; lua_shared_dict my_locks 1m; server { listen 80; server_name *.test.com; access_log logs/dyn_http.access.log default; location / { content_by_lua_file &#39;lua/dyn_http.lua&#39;; } } dyn_http.lua
local require = require local ngx = ngx local resolver = require &#34;resty.dns.resolver&#34; local resty_lock = require &#34;resty.lock&#34; local http = require &#34;resty.http&#34; local cache = ngx.shared.dns_cache local function fail(msg, err) ngx.
  </p>

  
  <footer>
    <a href="https://ops.m114.org/post/dynamic-http-proxy/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="https://ops.m114.org/post/nginx-ipip-service/">Nginx实现ip查询服务</a></h2>

    <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2021/06/03, 13:08</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://ops.m114.org/topics/OpenResty">OpenResty</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/OpenResty">OpenResty</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/Nginx">Nginx</a>
    
  </div>
  
  

</div>

  </header>

  <p>
  实现内部IP查询服务
 查询当前公网IP 查询当前公网IP地理信息，支持IPv4/IPv6 查询指定IP的地理信息，支持IPv4/IPv6  环境  CentOS 7 Nginx  lua-nginx-module lua-resty-ipmatcher lua-resty-ip2region lua-resty-maxminddb   IP库  ip2region ipv4库 maxminddb 免费ipv6库    配置 lua_shared_dict ip_data 10m; server { server_name ip.test.com; access_log logs/ip.access.log main buffer=32k flush=10s; error_log logs/ip.error.log; location / { default_type &#39;text/plain&#39;; access_by_lua_block { local remote_addr = ngx.var.remote_addr ngx.print(remote_addr) } } location = /ip { default_type application/json; content_by_lua_block { local require = require local ngx = ngx local cjson = require &#34;cjson.
  </p>

  
  <footer>
    <a href="https://ops.m114.org/post/nginx-ipip-service/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="https://ops.m114.org/post/gitea-webhook/">Gogs/Gitea webhook支持</a></h2>

    <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2021/06/03, 10:08</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://ops.m114.org/topics/OpenResty">OpenResty</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/OpenResty">OpenResty</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/Nginx">Nginx</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/Gogs">Gogs</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://ops.m114.org/tags/Gitea">Gitea</a>
    
  </div>
  
  

</div>

  </header>

  <p>
  实现需求为git提交后，自动同步至webhook所在机器的指定目录。也可以支持github的webhook，也能根据不同条件触发不同的webhook，如CI/CD。
环境  CentOS 7 Nginx  ngx_lua lua-resty-shell lua-resty-hmac    配置 对应nginx location配置
location = /webhook/deploy { content_by_lua_file &#39;lua/webhook/deploy.lua&#39;; } deploy.lua
-- Gogs Version: &gt;= v0.10 local require = require local ngx = ngx local cjson = require(&#34;cjson.safe&#34;) local shell = require(&#34;resty.shell&#34;) local hmac = require(&#34;resty.hmac&#34;) local json_encode = cjson.encode local json_decode = cjson.decode -- deploy config local config = { timeout = 30 * 1000, -- 30s socket = &#34;unix:/data/nginx/utils/shell.
  </p>

  
  <footer>
    <a href="https://ops.m114.org/post/gitea-webhook/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  

  


<nav class="pagination" role="pagination">
  
  <i class="fa fa-chevron-left"></i>
  
  <span>&nbsp;1 / 5&nbsp;</span>
  
  <a href="https://ops.m114.org/page/2/"><i class="fa fa-chevron-right"></i></a>
  
</nav>



</div>

</div>
</div>
<script src="https://ops.m114.org/js/ui.js"></script>
<script src="https://ops.m114.org/js/menus.js"></script>










</body>
</html>

