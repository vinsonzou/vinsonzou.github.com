<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title class=pjax-title>Kubernetes容器化 - Zookeeper - cloudSky's 小站</title><meta name=Description content="Linux运维"><meta property="og:title" content="Kubernetes容器化 - Zookeeper">
<meta property="og:description" content="Kubernetes官方有一个ZooKeeper教程。此文使用的是Docker官方镜像，主要是两个环境变量的设置 ZOO_MY_ID：用来指定"><meta property="og:type" content="article"><meta property="og:url" content="https://ops.m114.org/post/zookeeper-in-k8s/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-04T13:21:00+08:00"><meta property="article:modified_time" content="2022-10-04T13:21:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubernetes容器化 - Zookeeper"><meta name=twitter:description content="Kubernetes官方有一个ZooKeeper教程。此文使用的是Docker官方镜像，主要是两个环境变量的设置 ZOO_MY_ID：用来指定"><meta name=application-name content="cloudSky's 小站"><meta name=apple-mobile-web-app-title content="cloudSky's 小站"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://ops.m114.org/post/zookeeper-in-k8s/><link rel=prev href=https://ops.m114.org/post/k8s-basic-command/><link rel=next href=https://ops.m114.org/post/apisix-in-k8s-01/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Kubernetes容器化 - Zookeeper","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ops.m114.org\/post\/zookeeper-in-k8s\/"},"genre":"posts","keywords":"Kubernetes, zookeeper, 容器化","wordcount":1954,"url":"https:\/\/ops.m114.org\/post\/zookeeper-in-k8s\/","datePublished":"2022-10-04T13:21:00+08:00","dateModified":"2022-10-04T13:21:00+08:00","publisher":{"@type":"Organization","name":"CloudSky"},"author":{"@type":"Person","name":"CloudSky"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e)}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="cloudSky's 小站">cloudSky's 小站</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class='fa fa-list fa-fw'></i> 所有文章 </a><a class=menu-item href=/tags/><i class='fa fa-tags fa-fw'></i> 标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/links/><i class='fa fa-link fa-fw'></i> </a><span class="menu-item delimiter"></span><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="cloudSky's 小站">cloudSky's 小站</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title><i class='fa fa-list fa-fw'></i>所有文章</a><a class=menu-item href=/tags/ title><i class='fa fa-tags fa-fw'></i>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/links/ title><i class='fa fa-link fa-fw'></i></a><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Kubernetes容器化 - Zookeeper</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=https://ops.m114.org title=Author target=_blank rel="noopener noreffer author" class=author>CloudSky</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/kubernetes/><i class="far fa-folder fa-fw"></i>Kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-10-04>2022-10-04</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2022-10-04>2022-10-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1954 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#配置说明>配置说明</a></li><li><a href=#部署>部署</a></li><li><a href=#查看zookeeper配置>查看zookeeper配置</a></li><li><a href=#查看集群状态>查看集群状态</a></li><li><a href=#集群测试>集群测试</a></li><li><a href=#faq>FAQ</a><ul><li><a href=#poddisruptionbudget>PodDisruptionBudget</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>Kubernetes官方有一个<a href=https://kubernetes.io/zh/docs/tutorials/stateful-application/zookeeper/ target=_blank rel="noopener noreffer">ZooKeeper教程</a>。此文使用的是Docker官方镜像，主要是两个环境变量的设置</p><ul><li><code>ZOO_MY_ID</code>：用来指定myid文件中的编号</li><li><code>ZOO_SERVERS</code>：用来指定集群列表</li></ul><p>在Kubernetes中通过StatefulSet来部署，但<code>ZOO_MY_ID</code>环境变量无法通过Yaml文件注入到容器，网上找了一圈后，通过MySQL主从配置<code>server-id</code>跟我们配置zk集群一样，可通过pod ordinal index获得<code>ZOO_MY_ID</code>。</p><blockquote><p>StatefulSet 是用来管理有状态应用的工作负载 API 对象。</p><p>StatefulSet 中的 Pod 拥有一个具有黏性的、独一无二的身份标识。这个标识基于 StatefulSet 控制器分配给每个 Pod 的唯一顺序索引。Pod 的名称的形式为$(statefulset name)-$(ordinal index) 。例如：zk的StatefulSet 拥有三个副本，所以它创建了三个 Pod：zk-0、zk-1、zk-2。</p><p>和 Deployment 相同的是，StatefulSet 管理了基于相同容器定义的一组 Pod。但和 Deployment 不同的是，StatefulSet 为它们的每个 Pod 维护了一个固定的 ID。这些 Pod 是基于相同的声明来创建的，但是不能相互替换：无论怎么调度，每个 Pod 都有一个永久不变的 ID。</p><p>【使用场景】StatefulSets 对于需要满足以下一个或多个需求的应用程序很有价值：</p><ul><li>稳定的、唯一的网络标识符，即Pod重新调度后其PodName和HostName不变【当然IP是会变的】</li><li>稳定的、持久的存储，即Pod重新调度后还是能访问到相同的持久化数据，基于PVC实现</li><li>有序的、优雅的部署和缩放</li><li>有序的、自动的滚动更新</li></ul><p>如上面，稳定意味着 Pod 调度或重调度的整个过程是有持久性的。</p><p>如果应用程序不需要任何稳定的标识符或有序的部署、删除或伸缩，则应该使用由一组无状态的副本控制器提供的工作负载来部署应用程序，比如使用 Deployment 或者 ReplicaSet 可能更适用于无状态应用部署需要。</p></blockquote><h2 id=配置说明>配置说明</h2><ul><li>env设置<ul><li>ZOO_STANDALONE_ENABLED：<code>false</code></li><li>ZOO_ADMINSERVER_ENABLED：<code>false</code></li><li>ZOO_SERVERS：<code>server.1=zk-0.zk-hs.test.svc.cluster.local:2888:3888;2181 server.2=zk-1.zk-hs.test.svc.cluster.local:2888:3888;2181 server.3=zk-2.zk-hs.test.svc.cluster.local:2888:3888;2181</code><ul><li>zk-0.zk-hs.test.svc.cluster.local格式说明: <code>$(statefulset name)-$(pod ordinal index).$(serviceName).$(namespace).svc.cluster.local</code></li></ul></li></ul></li><li>动态PVC自动创建关联PV</li><li>ZOO_MY_ID通过<code>initContainers</code>写入至PVC中，即<code>/data/myid</code></li></ul><h2 id=部署>部署</h2><p>这里以一个3个节点的ZooKeeper集群为例，<code>zookeeper-headless.yaml</code>如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>zk-hs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>2888</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3888</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-election</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>zk-cs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>2181</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>policy/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PodDisruptionBudget</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>zk-pdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>zk-hs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>updateStrategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podManagementPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OrderedReady</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>podAntiAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;app&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>- <span class=l>zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;kubernetes.io/hostname&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>init-zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;zookeeper:3.6.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>bash</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          set -ex
</span></span></span><span class=line><span class=cl><span class=sd>          # Generate Zookeeper ZOO_MY_ID from pod ordinal index.
</span></span></span><span class=line><span class=cl><span class=sd>          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
</span></span></span><span class=line><span class=cl><span class=sd>          ordinal=${BASH_REMATCH[1]}
</span></span></span><span class=line><span class=cl><span class=sd>          # Add an offset to avoid reserved ZOO_MY_ID=0 value.
</span></span></span><span class=line><span class=cl><span class=sd>          echo $((1 + $ordinal)) &gt; /data/myid</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>zk-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>zk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;zookeeper:3.6.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>2181</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>2888</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3888</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-election</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>2181</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>2181</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ZOO_STANDALONE_ENABLED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ZOO_ADMINSERVER_ENABLED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ZOO_SERVERS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;server.1=zk-0.zk-hs.test.svc.cluster.local:2888:3888;2181 server.2=zk-1.zk-hs.test.svc.cluster.local:2888:3888;2181 server.3=zk-2.zk-hs.test.svc.cluster.local:2888:3888;2181&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>zk-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeClaimTemplates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>zk-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;ReadWriteOnce&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#selector: # 静态pvc需要绑定</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#  matchLabels:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#    pv: zk-pv</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 部署</span>
</span></span><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> apply -f zookeeper-headless.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看svc</span>
</span></span><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> get svc
</span></span><span class=line><span class=cl>NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>             AGE
</span></span><span class=line><span class=cl>zk-cs        ClusterIP   10.233.2.187    &lt;none&gt;        2181/TCP            29s
</span></span><span class=line><span class=cl>zk-hs        ClusterIP   None            &lt;none&gt;        2888/TCP,3888/TCP   29s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看pod</span>
</span></span><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> get pod
</span></span><span class=line><span class=cl>NAME   READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>zk-0   1/1     Running   <span class=m>0</span>          102s
</span></span><span class=line><span class=cl>zk-1   1/1     Running   <span class=m>0</span>          62s
</span></span><span class=line><span class=cl>zk-2   1/1     Running   <span class=m>0</span>          38s
</span></span></code></pre></div><h2 id=查看zookeeper配置>查看zookeeper配置</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> <span class=nb>exec</span> zk-0 -c zk -- cat /conf/zoo.cfg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>dataDir</span><span class=o>=</span>/data
</span></span><span class=line><span class=cl><span class=nv>dataLogDir</span><span class=o>=</span>/datalog
</span></span><span class=line><span class=cl><span class=nv>tickTime</span><span class=o>=</span><span class=m>2000</span>
</span></span><span class=line><span class=cl><span class=nv>initLimit</span><span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl><span class=nv>syncLimit</span><span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl>autopurge.snapRetainCount<span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl>autopurge.purgeInterval<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nv>maxClientCnxns</span><span class=o>=</span><span class=m>60</span>
</span></span><span class=line><span class=cl><span class=nv>standaloneEnabled</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl>admin.enableServer<span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl>server.1<span class=o>=</span>zk-0.zk-hs.test.svc.cluster.local:2888:3888<span class=p>;</span><span class=m>2181</span>
</span></span><span class=line><span class=cl>server.2<span class=o>=</span>zk-1.zk-hs.test.svc.cluster.local:2888:3888<span class=p>;</span><span class=m>2181</span>
</span></span><span class=line><span class=cl>server.3<span class=o>=</span>zk-2.zk-hs.test.svc.cluster.local:2888:3888<span class=p>;</span><span class=m>2181</span>
</span></span></code></pre></div><h2 id=查看集群状态>查看集群状态</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> <span class=nb>exec</span> zk-0 -c zk -- zkServer.sh status
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ZooKeeper JMX enabled by default
</span></span><span class=line><span class=cl>Using config: /conf/zoo.cfg
</span></span><span class=line><span class=cl>Client port found: 2181. Client address: localhost. Client SSL: false.
</span></span><span class=line><span class=cl>Mode: follower
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> <span class=nb>exec</span> zk-1 -c zk -- zkServer.sh status
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ZooKeeper JMX enabled by default
</span></span><span class=line><span class=cl>Using config: /conf/zoo.cfg
</span></span><span class=line><span class=cl>Client port found: 2181. Client address: localhost. Client SSL: false.
</span></span><span class=line><span class=cl>Mode: leader
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> <span class=nb>exec</span> zk-2 -c zk -- zkServer.sh status
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ZooKeeper JMX enabled by default
</span></span><span class=line><span class=cl>Using config: /conf/zoo.cfg
</span></span><span class=line><span class=cl>Client port found: 2181. Client address: localhost. Client SSL: false.
</span></span><span class=line><span class=cl>Mode: follower
</span></span></code></pre></div><p>可以看到：zk-1 是集群leader，zk-0 和 zk-2 是集群follower。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> <span class=nb>exec</span> zk-0 -c zk -- cat /data/myid
</span></span><span class=line><span class=cl><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> <span class=nb>exec</span> zk-1 -c zk -- cat /data/myid
</span></span><span class=line><span class=cl><span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> <span class=nb>exec</span> zk-2 -c zk -- cat /data/myid
</span></span><span class=line><span class=cl><span class=m>3</span>
</span></span></code></pre></div><h2 id=集群测试>集群测试</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> <span class=nb>exec</span> zk-0 -c zk -- zkCli.sh create /hello world
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>WATCHER::
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>WatchedEvent state:SyncConnected type:None path:null
</span></span><span class=line><span class=cl>Created /hello
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> <span class=nb>exec</span> zk-1 -c zk -- zkCli.sh get /hello
</span></span><span class=line><span class=cl>$ kubectl -n <span class=nb>test</span> <span class=nb>exec</span> zk-2 -c zk -- zkCli.sh get /hello
</span></span></code></pre></div><p>在 zk-0 创建的数据在集群中所有的服务上都是可用的。</p><h2 id=faq>FAQ</h2><h3 id=poddisruptionbudget>PodDisruptionBudget</h3><p>k8s可以为每个应用程序创建 PodDisruptionBudget 对象（PDB）。PDB 将限制在同一时间因资源干扰导致的复制应用程序中宕机的 pod 数量。</p><p>可以通过两个参数来配置PodDisruptionBudget</p><ul><li>MinAvailable：表示最小可用POD数，表示应用POD集群处于运行状态的最小POD数量，或者是运行状态的POD数同总POD数的最小百分比</li><li>MaxUnavailable：表示最大不可用PO数，表示应用POD集群处于不可用状态的最大POD数，或者是不可用状态的POD数同总POD数的最大百分比</li></ul><p>需要注意的是，MinAvailable参数和MaxUnavailable参数只能同时配置一个。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-10-04</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=# onclick=return!1 title="分享到 Twitter" data-sharer=twitter data-url=https://ops.m114.org/post/zookeeper-in-k8s/ data-title="Kubernetes容器化 - Zookeeper" data-hashtags=Kubernetes,zookeeper,容器化><i class="fab fa-twitter fa-fw"></i></a><a href=# onclick=return!1 title="分享到 Facebook" data-sharer=facebook data-url=https://ops.m114.org/post/zookeeper-in-k8s/ data-hashtag=Kubernetes><i class="fab fa-facebook-square fa-fw"></i></a><a href=# onclick=return!1 title="分享到 微博" data-sharer=weibo data-url=https://ops.m114.org/post/zookeeper-in-k8s/ data-title="Kubernetes容器化 - Zookeeper"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/kubernetes/>Kubernetes</a>,&nbsp;<a href=/tags/zookeeper/>zookeeper</a>,&nbsp;<a href=/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/>容器化</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/post/k8s-basic-command/ class=prev rel=prev title=k8s查看集群信息及基本命令><i class="fas fa-angle-left fa-fw"></i>k8s查看集群信息及基本命令</a>
<a href=/post/apisix-in-k8s-01/ class=next rel=next title="APISIX在k8s的使用01: 离线安装及初步使用">APISIX在k8s的使用01: 离线安装及初步使用<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.121.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreffer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2014 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://ops.m114.org target=_blank rel="noopener noreferrer">CloudSky</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/topbar/topbar.min.js></script><script type=text/javascript src=/lib/pjax/pjax.min.js></script><script type=text/javascript src=/js/theme.min.js></script></div><div class=pjax-assets><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"vinsonzou/vinsonzou.github.com"}},sharerjs:!0}</script></div></body></html>