<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title class=pjax-title>Lua实现返回内容gzip解压/压缩 - cloudSky's 小站</title><meta name=Description content="Linux运维"><meta property="og:title" content="Lua实现返回内容gzip解压/压缩"><meta property="og:description" content="背景 最近要获取 jira 返回数据更新关注列表，jira 服务器的请求和返回的数据默认进行了 gzip 压缩。目前有 2 种方式 jira 设置中关闭 gzip 压缩 使用 lua 对 gzip 进行解压，"><meta property="og:type" content="article"><meta property="og:url" content="https://ops.m114.org/post/lua-gzip/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-12T12:43:03+08:00"><meta property="article:modified_time" content="2023-05-12T12:43:03+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lua实现返回内容gzip解压/压缩"><meta name=twitter:description content="背景 最近要获取 jira 返回数据更新关注列表，jira 服务器的请求和返回的数据默认进行了 gzip 压缩。目前有 2 种方式 jira 设置中关闭 gzip 压缩 使用 lua 对 gzip 进行解压，"><meta name=application-name content="cloudSky's 小站"><meta name=apple-mobile-web-app-title content="cloudSky's 小站"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://ops.m114.org/post/lua-gzip/><link rel=prev href=https://ops.m114.org/post/apk-signature-scheme-v2-integer-overflow/><link rel=next href=https://ops.m114.org/post/go-channel-blocking-of-stepping-pit-series/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Lua实现返回内容gzip解压/压缩","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ops.m114.org\/post\/lua-gzip\/"},"genre":"posts","keywords":"OpenResty","wordcount":1069,"url":"https:\/\/ops.m114.org\/post\/lua-gzip\/","datePublished":"2023-05-12T12:43:03+08:00","dateModified":"2023-05-12T12:43:03+08:00","publisher":{"@type":"Organization","name":"CloudSky"},"author":{"@type":"Person","name":"CloudSky"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e)}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="cloudSky's 小站">cloudSky's 小站</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class='fa fa-list fa-fw'></i> 所有文章 </a><a class=menu-item href=/tags/><i class='fa fa-tags fa-fw'></i> 标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/links/><i class='fa fa-link fa-fw'></i> </a><span class="menu-item delimiter"></span><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="cloudSky's 小站">cloudSky's 小站</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title><i class='fa fa-list fa-fw'></i>所有文章</a><a class=menu-item href=/tags/ title><i class='fa fa-tags fa-fw'></i>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/links/ title><i class='fa fa-link fa-fw'></i></a><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Lua实现返回内容gzip解压/压缩</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=https://ops.m114.org title=Author target=_blank rel="noopener noreffer author" class=author>CloudSky</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/openresty/><i class="far fa-folder fa-fw"></i>OpenResty</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-05-12>2023-05-12</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-05-12>2023-05-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1069 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 3 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#http-压缩过程>HTTP 压缩过程</a></li><li><a href=#lua-zlib>Lua-zlib</a></li></ul></nav></div></div><div class=content id=content><h2 id=背景>背景</h2><p>最近要获取 jira 返回数据更新关注列表，jira 服务器的请求和返回的数据默认进行了 gzip 压缩。目前有 2 种方式</p><ul><li>jira 设置中关闭 gzip 压缩</li><li>使用 lua 对 gzip 进行解压，参考库<a href=https://github.com/brimworks/lua-zlib target=_blank rel="noopener noreffer">lua-zlib</a></li></ul><h2 id=http-压缩过程>HTTP 压缩过程</h2><p>可能有的小伙伴，不知道传输内容 gzip 压缩是什么？是一个什么样的过程，在这里科普一下。</p><p>在 HTTP 协议中，可以对内容（也就是 body 部分）进行编码，可以采用 gzip 这样的编码，达到压缩的目的。也可以使用其它的编码对内容搅乱或加密，以此来防止未授权的第三方看到传输的内容。一般 HTTP 比较通用的压缩算法就是 gzip，通过 gzip 来压缩 html、javascript、CSS 文件。能大大减少网络传输的数据量，提高用户显示网页的熟读，当然同时会增加一点点服务器的开销。</p><p>下面简单说下压缩的过程：</p><ul><li>浏览器发送 Http Request 给 Web 服务器, request 中有 Accept-Encoding: gzip,deflate。 (告诉服务器， 浏览器支持 gzip 压缩)</li><li>Web 服务器接到 Request 后， 生成原始的 Response, 其中有原始的 Content-Type 和 Content-Length</li><li>Web 服务器通过 Gzip，来对 Response 进行编码，编码后 header 中有 Content-Type 和 Content-Length (压缩后的大小)，并且增加了 Content-Encoding:gzip。然后把 Response 发送给浏览器</li><li>浏览器接到 Response 后，根据 Content-Encoding:gzip 来对 Response 进行解码。获取到原始 Response 后，然后显示出网页</li></ul><h2 id=lua-zlib>Lua-zlib</h2><p>使用源码编译步骤如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://github.com/brimworks/lua-zlib/archive/master.zip
</span></span><span class=line><span class=cl>unzip master.zip
</span></span><span class=line><span class=cl><span class=nb>cd</span> lua-zlib-master
</span></span><span class=line><span class=cl>cmake -DLUA_INCLUDE_DIR<span class=o>=</span>/usr/local/openresty/luajit/include/luajit-2.1 -DLUA_LIBRARIES<span class=o>=</span>/usr/local/openresty/luajit/lib -DUSE_LUAJIT<span class=o>=</span>ON -DUSE_LUA<span class=o>=</span>OFF
</span></span><span class=line><span class=cl>make <span class=o>&amp;&amp;</span> make install
</span></span></code></pre></div><p>编译后，将编译生成的 <code>zlib.so</code> 复制到 <code>/usr/local/openresty/lualib/</code> 目录下</p><p>首先使用 cmake 来生成编译配置文件</p><ul><li><code>LUA_INCLUDE_DIR</code> 指定 luajit 的 include 文件夹</li><li><code>LUA_LIBRARIES</code> 指定 luajit 的 lib 文件夹</li><li><code>USE_LUAJIT = ON</code> 和 <code>USE_LUA = OFF</code> 指定我们使用的是 luajit</li></ul><p>使用方式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>zlib</span> <span class=o>=</span> <span class=n>require</span><span class=p>(</span><span class=s2>&#34;zlib&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- 压缩</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>compress</span> <span class=o>=</span> <span class=n>zlib.deflate</span><span class=p>()(</span><span class=n>body</span><span class=p>,</span> <span class=s2>&#34;finish&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- 解压缩</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>uncompress</span> <span class=o>=</span> <span class=n>zlib.inflate</span><span class=p>()(</span><span class=n>compress</span><span class=p>)</span>
</span></span></code></pre></div><p>使用起来是不是很简单，我以为就要大功告成了，结果出现了问题，原本这个插件的作用就是将服务器返回的压缩过的数据进行解压并解析，过滤一些敏感的信息，再压缩继续返回，解压解析一切正常，再压缩就出了问题，原来是因为 gzip 有附加的 header，而如果在使用 deflate() 方法不设置参数的话，默认得到的是 zlib 压缩内容，而不是 gzip 压缩内容，因此压缩的使用方式需要修改下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>zlib</span> <span class=o>=</span> <span class=n>require</span><span class=p>(</span><span class=s2>&#34;zlib&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- input:  string</span>
</span></span><span class=line><span class=cl><span class=c1>-- output: string compressed with gzip</span>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>compress</span><span class=p>(</span><span class=n>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=kd>local</span> <span class=n>level</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>   <span class=kd>local</span> <span class=n>windowSize</span> <span class=o>=</span> <span class=mi>15</span><span class=o>+</span><span class=mi>16</span>
</span></span><span class=line><span class=cl>   <span class=kr>return</span> <span class=n>zlib.deflate</span><span class=p>(</span><span class=n>level</span><span class=p>,</span> <span class=n>windowSize</span><span class=p>)(</span><span class=n>str</span><span class=p>,</span> <span class=s2>&#34;finish&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><p>在文档里有说明 function stream = zlib.deflate([ int compression_level ], [ int window_size ])</p><pre tabindex=0><code>If no compression_level is provided uses Z_DEFAULT_COMPRESSION (6),
compression level is a number from 1-9 where zlib.BEST_SPEED is 1
and zlib.BEST_COMPRESSION is 9.

Returns a &#34;stream&#34; function that compresses (or deflates) all
strings passed in.  Specifically, use it as such:

string deflated, bool eof, int bytes_in, int bytes_out =
        stream(string input [, &#39;sync&#39; | &#39;full&#39; | &#39;finish&#39;])

    Takes input and deflates and returns a portion of it,
    optionally forcing a flush.

    A &#39;sync&#39; flush will force all pending output to be flushed to
    the return value and the output is aligned on a byte boundary,
    so that the decompressor can get all input data available so
    far.  Flushing may degrade compression for some compression
    algorithms and so it should be used only when necessary.

    A &#39;full&#39; flush will flush all output as with &#39;sync&#39;, and the
    compression state is reset so that decompression can restart
    from this point if previous compressed data has been damaged
    or if random access is desired. Using Z_FULL_FLUSH too often
    can seriously degrade the compression.

    A &#39;finish&#39; flush will force all pending output to be processed
    and results in the stream become unusable.  Any future
    attempts to print anything other than the empty string will
    result in an error that begins with IllegalState.

    The eof result is true if &#39;finish&#39; was specified, otherwise
    it is false.

    The bytes_in is how many bytes of input have been passed to
    stream, and bytes_out is the number of bytes returned in
    deflated string chunks.
</code></pre><p>搞定收工！</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-05-12</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=# onclick=return!1 title="分享到 Twitter" data-sharer=twitter data-url=https://ops.m114.org/post/lua-gzip/ data-title=Lua实现返回内容gzip解压/压缩 data-hashtags=OpenResty><i class="fab fa-twitter fa-fw"></i></a><a href=# onclick=return!1 title="分享到 Facebook" data-sharer=facebook data-url=https://ops.m114.org/post/lua-gzip/ data-hashtag=OpenResty><i class="fab fa-facebook-square fa-fw"></i></a><a href=# onclick=return!1 title="分享到 微博" data-sharer=weibo data-url=https://ops.m114.org/post/lua-gzip/ data-title=Lua实现返回内容gzip解压/压缩><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/openresty/>OpenResty</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/post/apk-signature-scheme-v2-integer-overflow/ class=prev rel=prev title=解决Android安装包签名异常><i class="fas fa-angle-left fa-fw"></i>解决Android安装包签名异常</a>
<a href=/post/go-channel-blocking-of-stepping-pit-series/ class=next rel=next title="[Go] 踩坑系列之channel阻塞">[Go] 踩坑系列之channel阻塞<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.118.2">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreffer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2014 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://ops.m114.org target=_blank rel="noopener noreferrer">CloudSky</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/topbar/topbar.min.js></script><script type=text/javascript src=/lib/pjax/pjax.min.js></script><script type=text/javascript src=/js/theme.min.js></script></div><div class=pjax-assets><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"vinsonzou/vinsonzou.github.com"}},sharerjs:!0}</script></div></body></html>